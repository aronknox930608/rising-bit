format_version: 1.3.0
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

workflows:
  test:
    steps:
    - script:
        title: JSON params tests
        inputs:
        - content: |-
            #!/bin/bash

            echo "run test"
            out=$($CURRENT_BITRISE run --json-params '{"config":"./_tests/integration_tests/json_params_tests/test-bitrise.yml", "workflow":"json_params_test_target"}')
            status=$?
            echo "status: $status"
            if [ $status -ne 0 ] ; then
              echo "out: $out"
              exit 1
            fi
            echo "----------"

            echo "run test - param override"
            out=$($CURRENT_BITRISE run --json-params '{"config":"./_tests/integration_tests/json_params_tests/test-bitrise.yml", "workflow":"exit_code_test_fail"}' --workflow json_params_test_target)
            status=$?
            echo "status: $status"
            if [ $status -ne 0 ] ; then
              echo "out: $out"
              exit 1
            fi
            echo "----------"

            echo "trigger test"
            out=$($CURRENT_BITRISE trigger --json-params '{"config":"./_tests/integration_tests/json_params_tests/test-bitrise.yml", "pattern":"json_params_test_target"}')
            status=$?
            echo "status: $status"
            if [ $status -ne 0 ] ; then
              echo "out: $out"
              exit 1
            fi
            echo "----------"

            echo "trigger test - param override"
            out=$($CURRENT_BITRISE trigger --json-params '{"config":"./_tests/integration_tests/json_params_tests/test-bitrise.yml", "pattern":"exit_code_test_fail"}' --pattern json_params_test_target)
            status=$?
            echo "status: $status"
            if [ $status -ne 0 ] ; then
              echo "out: $out"
              exit 1
            fi
            echo "----------"

            echo "run test base64"
            base64_params=$(echo '{"config":"./_tests/integration_tests/json_params_tests/test-bitrise.yml", "workflow":"json_params_test_target"}'|openssl base64)
            out=$($CURRENT_BITRISE run --json-params-base64 "$base64_params")
            status=$?
            echo "status: $status"
            if [ $status -ne 0 ] ; then
              echo "out: $out"
              exit 1
            fi
            echo "----------"

            echo "trigger test base64"
            base64_params=$(echo '{"config":"./_tests/integration_tests/json_params_tests/test-bitrise.yml", "pattern":"json_params_test_target"}'|openssl base64)
            out=$($CURRENT_BITRISE trigger --json-params-base64 "$base64_params")
            status=$?
            echo "status: $status"
            if [ $status -ne 0 ] ; then
              echo "out: $out"
              exit 1
            fi
            echo "----------"

            echo "trigger check test"
            out=$($CURRENT_BITRISE trigger-check --json-params '{"config":"./_tests/integration_tests/json_params_tests/test-bitrise.yml","pattern":"json_params_test_target","format":"json"}')
            status=$?
            echo "status: $status"
            if [ $status -ne 0 ] ; then
              echo "out: $out"
              exit 1
            fi
            if [ "$out" != '{"pattern":"json_params_test_target","workflow":"json_params_test_target"}' ] ; then
              echo "out: $out"
              exit 1
            fi
            echo "----------"

            echo "trigger check test - param override"
            out=$($CURRENT_BITRISE trigger-check --json-params '{"config":"./_tests/integration_tests/json_params_tests/test-bitrise.yml","pattern":"json_params_test_target","format":"raw"}' --format json)
            status=$?
            echo "status: $status"
            if [ $status -ne 0 ] ; then
              echo "out: $out"
              exit 1
            fi
            if [ "$out" != '{"pattern":"json_params_test_target","workflow":"json_params_test_target"}' ] ; then
              echo "out: $out"
              exit 1
            fi